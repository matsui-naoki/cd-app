# CD Analyzer 実装計画書

## 現状分析

### 実装済み機能

| 機能 | 状態 | 備考 |
|------|------|------|
| MPT/MPR/MPS ファイル読み込み | ✅ 完了 | Universal MPR parser実装済み |
| V-t プロット | ✅ 完了 | 基本機能のみ |
| V-Q プロット | ✅ 完了 | 基本機能のみ |
| dQ/dV プロット | ✅ 完了 | 基本機能のみ |
| サイクルサマリー | ✅ 完了 | 基本機能のみ |
| 容量維持率プロット | ✅ 完了 | 基本機能のみ |
| EIS ナイキストプロット | ✅ 完了 | |
| CSV/Igor エクスポート | ✅ 完了 | |

### 未実装・改善必要な機能

| 機能 | 優先度 | 説明 |
|------|--------|------|
| サンプル情報入力UI | 高 | 活物質重量・面積の入力 |
| サイクル選択機能 | 高 | 特定サイクルのみ表示 |
| 容量単位切り替え | 高 | mAh/g ↔ mAh/cm² |
| グラフスタイル設定 | 高 | 論文用体裁 |
| 軸範囲調整 | 中 | オートレンジ・マニュアル設定 |
| 図のエクスポート (SVG/PNG) | 中 | 高解像度出力 |
| ボードプロット | 低 | EIS追加機能 |
| 測定手法自動判別 | 低 | ファイルからの自動検出 |

---

## Phase 1: サンプル情報UI改善 (最優先)

### 1.1 サンプル情報入力パネル

**現状の問題**:
- サンプル情報の入力箇所が分散
- 容量計算に必要なパラメータが設定しにくい

**実装内容**:
```
サイドバー「サンプル情報」セクション:
├── 📝 サンプル名 [テキスト入力]
├── ⚖️ 活物質重量 [数値入力 mg]
├── 📊 活物質比率 [スライダー 0-1]
├── 📐 電極面積 [数値入力 cm²] (デフォルト: 0.636)
├── 🔄 容量単位 [ラジオボタン: mAh/g | mAh/cm²]
└── 💡 計算済み活物質重量: XX mg (自動計算表示)
```

**コード変更箇所**:
- `app.py`: `sidebar_sample_info()` 関数の改善
- `utils/helpers.py`: 単位変換関数の追加

### 1.2 容量単位切り替え機能

**実装内容**:
- mAh/g (重量容量) と mAh/cm² (面積容量) の切り替え
- 全プロットに反映
- 軸ラベルの自動更新

**変換式**:
```python
# mAh/g → mAh/cm²
capacity_area = capacity_mass * loading_mg_cm2 * 1e-3
# loading = mass_mg / area_cm2
```

---

## Phase 2: サイクル選択・表示改善

### 2.1 サイクル選択UI

**実装内容**:
```
サイドバー「サイクル選択」セクション:
├── 📊 全サイクル表示 [チェックボックス]
├── 🔢 サイクル範囲 [スライダー: min - max]
├── ✅ 特定サイクル選択 [マルチセレクト]
└── 🎨 カラーモード [ドロップダウン: 単色 | サイクル番号 | 充放電]
```

**コード変更箇所**:
- `app.py`: サイクル選択UI追加
- `components/plots.py`: サイクルフィルタリング機能

### 2.2 充電/放電の色分け

**実装内容**:
- 充電: 赤系 (#E63946)
- 放電: 青系 (#457B9D)
- または rainbow colormap by cycle number

---

## Phase 3: グラフスタイル設定

### 3.1 論文用プリセット

**実装内容**:
```
「スタイル設定」パネル:
├── 📄 プリセット [ドロップダウン: 論文用 | プレゼン用 | カスタム]
├── 📝 フォント [ドロップダウン: Arial | Helvetica | Times]
├── 📏 フォントサイズ [数値: 10-18 pt]
├── ➖ 線幅 [スライダー: 0.5-3 pt]
├── ⭕ マーカー [ドロップダウン: なし | ○ | ● | □ | ■]
├── 📐 マーカーサイズ [スライダー: 1-10]
└── 🔲 背景色 [カラーピッカー: 白/透明]
```

### 3.2 軸ラベルフォーマット

**実装内容**:
- イタリック体の変数名 (V, C, Q)
- 上付き/下付き文字のサポート
- 単位の正確な表記 (mAh g⁻¹, Ω·cm²)

---

## Phase 4: 軸操作・エクスポート

### 4.1 軸範囲設定

**実装内容**:
```
「軸設定」パネル:
├── X軸
│   ├── 🔄 オートレンジ [ボタン]
│   ├── 📏 手動設定 [min - max]
│   └── ➡️ シフト [数値入力]
├── Y軸 (左)
│   ├── 🔄 オートレンジ [ボタン]
│   └── 📏 手動設定 [min - max]
└── Y軸 (右) ※該当時のみ
    └── 同上
```

### 4.2 図のエクスポート

**実装内容**:
```
「エクスポート」パネル:
├── 📷 図の保存
│   ├── フォーマット [ドロップダウン: PNG | SVG | PDF]
│   ├── 解像度 [ドロップダウン: 72 | 150 | 300 | 600 dpi]
│   ├── サイズ [幅 × 高さ mm]
│   └── [保存ボタン]
├── 📊 データ保存
│   ├── CSV [ボタン]
│   └── Igor Text [ボタン]
└── 📋 レポート
    └── サマリーPDF [ボタン]
```

---

## ファイル変更計画

### 新規作成

```
cd-app/
├── components/
│   └── sample_info.py      # サンプル情報パネル
├── utils/
│   └── unit_converter.py   # 単位変換ユーティリティ
└── docs/
    ├── SPECIFICATION.md    # 作成済み
    └── IMPLEMENTATION_PLAN.md  # 本ファイル
```

### 修正ファイル

| ファイル | 変更内容 |
|----------|----------|
| `app.py` | サンプル情報UI、サイクル選択UI追加 |
| `components/plots.py` | サイクルフィルタ、色分け、スタイル設定 |
| `utils/helpers.py` | 単位変換、容量計算関数追加 |

---

## 開発スケジュール案

| Phase | 内容 | 優先度 |
|-------|------|--------|
| 1 | サンプル情報UI・容量単位切り替え | 🔴 高 |
| 2 | サイクル選択・色分け | 🔴 高 |
| 3 | グラフスタイル設定 | 🟡 中 |
| 4 | 軸操作・エクスポート | 🟡 中 |
| 5 | 測定手法自動判別・追加機能 | 🟢 低 |

---

## 次のアクション

1. Phase 1 のサンプル情報UIを実装
2. 容量単位切り替え機能を追加
3. V-Q プロットにサイクル選択機能を追加
4. テストデータで動作確認

---

*実装計画バージョン: 1.0*
*作成日: 2024-12-10*
